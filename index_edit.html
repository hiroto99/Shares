<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="/static/favicon.png" crossorigin="use-credentials" />
		<link
			rel="icon"
			type="image/png"
			href="/static/favicon-96x96.png"
			sizes="96x96"
			crossorigin="use-credentials"
		/>
		<link
			rel="icon"
			type="image/svg+xml"
			href="/static/favicon.svg"
			crossorigin="use-credentials"
		/>
		<link rel="shortcut icon" href="/static/favicon.ico" crossorigin="use-credentials" />
		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="/static/apple-touch-icon.png"
			crossorigin="use-credentials"
		/>
		<link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
		/>
		<meta name="theme-color" content="#171717" />
		<meta name="robots" content="noindex,nofollow" />

		<script src="/static/loader.js" defer crossorigin="use-credentials"></script>
		<link rel="stylesheet" href="/static/custom.css" crossorigin="use-credentials" />

		<script>
			function resizeIframe(obj) {
				obj.style.height = obj.contentWindow.document.documentElement.scrollHeight + 'px';
			}
		</script>

		<script>
			// On page load or when changing themes, best to add inline in `head` to avoid FOUC
			(() => {
				const metaThemeColorTag = document.querySelector('meta[name="theme-color"]');
				const prefersDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

				if (!localStorage?.theme) {
					localStorage.theme = 'system';
				}

				if (localStorage.theme === 'system') {
					document.documentElement.classList.add(prefersDarkTheme ? 'dark' : 'light');
					metaThemeColorTag.setAttribute('content', prefersDarkTheme ? '#171717' : '#ffffff');
				} else if (localStorage.theme === 'oled-dark') {
					document.documentElement.style.setProperty('--color-gray-800', '#101010');
					document.documentElement.style.setProperty('--color-gray-850', '#050505');
					document.documentElement.style.setProperty('--color-gray-900', '#000000');
					document.documentElement.style.setProperty('--color-gray-950', '#000000');
					document.documentElement.classList.add('dark');
					metaThemeColorTag.setAttribute('content', '#000000');
				} else if (localStorage.theme === 'light') {
					document.documentElement.classList.add('light');
					metaThemeColorTag.setAttribute('content', '#ffffff');
				} else if (localStorage.theme === 'her') {
					document.documentElement.classList.add('her');
					metaThemeColorTag.setAttribute('content', '#983724');
				} else {
					document.documentElement.classList.add('dark');
					metaThemeColorTag.setAttribute('content', '#171717');
				}

				window.matchMedia('(prefers-color-scheme: dark)').addListener((e) => {
					if (localStorage.theme === 'system') {
						if (e.matches) {
							document.documentElement.classList.add('dark');
							document.documentElement.classList.remove('light');
							metaThemeColorTag.setAttribute('content', '#171717');
						} else {
							document.documentElement.classList.add('light');
							document.documentElement.classList.remove('dark');
							metaThemeColorTag.setAttribute('content', '#ffffff');
						}
					}
				});
				const isDarkMode = document.documentElement.classList.contains('dark');

				const logo = document.createElement('img');
				logo.id = 'logo';
				logo.style =
					'position: absolute; width: auto; height: 6rem; top: 44%; left: 50%; transform: translateX(-50%); display:block;';
				logo.src = isDarkMode ? '/static/splash-dark.png' : '/static/splash.png';

				document.addEventListener('DOMContentLoaded', function () {
					const splash = document.getElementById('splash-screen');
					if (document.documentElement.classList.contains('her')) {
						return;
					}

					if (splash) splash.prepend(logo);
				});
			})();
		</script>

		<title>Open WebUI</title>

		
		<link rel="modulepreload" href="/_app/immutable/entry/start.Dmgif7-p.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/Cn6Y74dG.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/Cq_rWCdd.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/D-dubyUK.js">
		<link rel="modulepreload" href="/_app/immutable/entry/app.BgKswP6l.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/C1FmrZbK.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/CZ24kPaO.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/CWj6FrbW.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/DlYoNXTi.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/BxvShNB-.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/BMifpPng.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/DwH1BKTo.js">
		<link rel="modulepreload" href="/_app/immutable/chunks/DYhThC2r.js">
	</head>

	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">
			<script>
				{
					__sveltekit_1ecvgau = {
						base: ""
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("/_app/immutable/entry/start.Dmgif7-p.js"),
						import("/_app/immutable/entry/app.BgKswP6l.js")
					]).then(([kit, app]) => {
						kit.start(app, element);
					});
				}
			</script>
		</div>

		<div
			id="splash-screen"
			style="position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%"
		>
			<style type="text/css" nonce="">
				html {
					overflow-y: scroll !important;
				}
			</style>

			<div
				style="
					position: absolute;
					top: 33%;
					left: 50%;

					width: 24rem;
					transform: translateX(-50%);

					display: flex;
					flex-direction: column;
					align-items: center;
				"
			>
				<img
					id="logo-her"
					style="width: auto; height: 13rem"
					src="/static/splash.png"
					class="animate-pulse-fast"
				/>

				<div style="position: relative; width: 24rem; margin-top: 0.5rem">
					<div
						id="progress-background"
						style="
							position: absolute;
							width: 100%;
							height: 0.75rem;

							border-radius: 9999px;
							background-color: #fafafa9a;
						"
					></div>

					<div
						id="progress-bar"
						style="
							position: absolute;
							width: 0%;
							height: 0.75rem;
							border-radius: 9999px;
							background-color: #fff;
						"
						class="bg-white"
					></div>
				</div>
			</div>

			<!-- <span style="position: absolute; bottom: 32px; left: 50%; margin: -36px 0 0 -36px">
				Footer content
			</span> -->
		</div>
		<!-- hiroto99.com ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé–‹å§‹ -->
		<!-- 1. æ–™é‡‘ãƒ—ãƒ©ãƒ³ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
		<div id="pricing-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2147483647; align-items: center; justify-content: center;">
			<div style="background: #171717; padding: 30px; border-radius: 20px; width: 90%; max-width: 900px; position: relative; border: 1px solid #333;">
				<button onclick="document.getElementById('pricing-modal').style.display='none'" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">&times;</button>
				<h2 style="color: white; text-align: center; margin-bottom: 20px;">ãƒãƒ£ãƒ¼ã‚¸ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ</h2>
				
				<!-- ğŸ’¡ ã“ã“ã«Stripeã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸåŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šã¾ã™ -->
				<script async src="https://js.stripe.com/v3/buy-button.js"></script>

				<!-- 2. Stripeã®100ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè³¼å…¥ãƒœã‚¿ãƒ³ -->
				<stripe-buy-button
				id="pricing-table"
				buy-button-id="buy_btn_1T2BtaRl2ex7Wx2FrLHUoFzh"
				publishable-key="pk_test_51T24k3Rl2ex7Wx2FrPYgvfQXXHWzPjS75Mtvhc6pqJWtMtAL43aSqf6UKoMAF7MEISGVHqnBQ6a6y6BxKIeMpaGA002VQBaiHD">
				</stripe-buy-button>
				<!-- 3. Stripeã®200ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè³¼å…¥ãƒœã‚¿ãƒ³ -->
				<stripe-buy-button
				id="pricing-table"
				buy-button-id="buy_btn_1T4uBNRl2ex7Wx2F4Hs1EWyy"
				publishable-key="pk_test_51T24k3Rl2ex7Wx2FrPYgvfQXXHWzPjS75Mtvhc6pqJWtMtAL43aSqf6UKoMAF7MEISGVHqnBQ6a6y6BxKIeMpaGA002VQBaiHD">
				</stripe-buy-button>
			</div>
		</div>
		<!-- 2. å³ä¸‹ã®ç‰©ç†çš„ãªã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆæœ€åˆã‹ã‚‰è¡¨ç¤ºã•ã›ã¦ãŠãï¼‰ -->
		<div id="final-widget-fixed" 
			onmouseover="this.style.right='20px'; this.style.opacity='1'; this.style.width='220px';"
			onmouseout="this.style.right='-170px'; this.style.opacity='0.6'; this.style.width='220px';"
			style="position: fixed !important; bottom: 30px !important; right: -170px !important; width: 220px !important; z-index: 2147483647 !important; background: rgba(17, 17, 17, 0.9) !important; backdrop-filter: blur(10px); border: 1px solid #333 !important; border-radius: 16px !important; padding: 15px !important; box-shadow: 0 10px 40px rgba(0,0,0,0.6) !important; color: #fff !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.6; cursor: default;">
			
			<div style="display: flex; align-items: center; gap: 10px;">
				<span style="font-size: 18px;">ğŸª™</span>
				<div>
					<div style="font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Credit Balance</div>
					<div id="final-credits-display" style="font-size: 24px; font-weight: 800; color: #3b82f6; line-height: 1;">-- c</div>
				</div>
			</div>
			
			<div style="margin-top: 15px; border-top: 1px solid #222; padding-top: 12px;">
				<button id="final-charge-btn" onclick="window.openPricingModal()" 
					style="width: 100% !important; background: #3b82f6 !important; color: white !important; padding: 10px !important; border-radius: 10px !important; border: none !important; font-size: 13px !important; font-weight: 700; cursor: pointer !important;">
					ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹
				</button>
			</div>
		</div>

		<!-- 3. è¡¨ç¤ºã‚’å¼·åˆ¶ç¶­æŒã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
		<script>
			(function() {
				const W_ID = 'final-widget-fixed';
				const S_URL = "https://buy.stripe.com/test_eVq7sNgH637d1NFefc2Ji00";
				const GET_API_URL = "https://n8n.hiroto99.com/webhook/a1e74358-e322-4805-ae83-84e611115199"; // ğŸ’¡ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå–å¾—ç”¨API
				const USE_API_URL = "https://n8n.hiroto99.com/webhook/7e983263-2397-42d6-ab7d-bce4e12f1e91"; // ğŸ’¡ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»ç”¨API
				let creditsSave = null; // ğŸ’¡ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®æœ€æ–°å€¤ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
				window.hiroto99_is_locked = false; // ğŸ’¡ windowã«æŒãŸã›ã¦æ¶ˆå¤±ã‚’é˜²ã

				async function refresh() {
					const widget = document.getElementById(W_ID);
					if (!widget) return;

					// ğŸ’¡ éš”é›¢ï¼šå¸¸ã«æœ€ä¸Šä½ã¸ç§»å‹•
					if (widget.parentElement !== document.documentElement) {
						document.documentElement.appendChild(widget);
					}
					widget.style.setProperty('display', 'block', 'important');

					try {
						// 0. ãƒ­ã‚¯ã‚™ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
						const token = localStorage.getItem('token');
						if (!token) return; // ãƒ­ã‚°ã‚¤ãƒ³å‰ãªã‚‰æ•°å€¤ã ã‘ -- c ã®ã¾ã¾

						// æ‰€æŒã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®è¡¨ç¤º
						// 1. ãƒˆãƒ¼ã‚¯ãƒ³(JWT)ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦IDã‚’å–å¾—
						const user = JSON.parse(atob(token.split('.')[1]));
						const userId = user.id;

						// 2. Python API ã‹ã‚‰æœ€æ–°ã®æ®‹é«˜ã‚’å–å¾—ï¼ˆlocalStorageã«é ¼ã‚‰ãªã„ï¼‰
						const response = await fetch(GET_API_URL, {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ user_id: userId })
						});
						if (!response.ok) throw new Error('API Response Error');
						const data = await response.json();
						
						// ğŸ’¡ n8nã®é…åˆ—å½¢å¼ [ { "credits": 700 } ] ã«å¯¾å¿œã•ã›ã‚‹
						const credits = (Array.isArray(data) && data[0]) ? data[0].credits : (data.credits || 0);

						// 3. è¡¨ç¤ºã®æ›´æ–°
						const displayEl = document.getElementById('final-credits-display');
						if (displayEl) displayEl.innerText = credits + " c";

						// ãƒãƒ£ãƒ¼ã‚¸ç”»é¢ã®æœ‰åŠ¹åŒ–
						document.getElementById('final-charge-btn').onclick = function() {
							// 4. Stripeã®æ–™é‡‘è¡¨ã«IDã‚’æµã—è¾¼ã‚€ï¼ˆé‡è¦ï¼šã“ã‚Œã§èª°ã®æ±ºæ¸ˆã‹åˆ¤åˆ¥ã™ã‚‹ï¼‰
							const table = document.getElementById('my-stripe-table');
							if (table) {
								table.setAttribute('client-reference-id', userId);
							}

							// 5. Stripeæ–™é‡‘è¡¨ã‚¿ã‚°ã‚’å–å¾—ã—ã€client-reference-id ã‚’å‹•çš„ã«ä»˜ä¸
							const pricingTable = document.getElementById('pricing-table');
							if (pricingTable) {
								// ã“ã“ã§ ID ã‚’ã‚»ãƒƒãƒˆï¼ Stripeå´ã¯ã“ã®å±æ€§ã‚’è‡ªå‹•ã§èª­ã¿å–ã‚Šã¾ã™
								pricingTable.setAttribute('client-reference-id', userId);
								
								// ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚è‡ªå‹•å…¥åŠ›ã•ã›ãŸã„å ´åˆ
								const userStr = localStorage.getItem('user');
								if (userStr) {
									const userObj = (typeof userStr === 'string') ? JSON.parse(userStr) : userStr;
									if (userObj.email) {
										pricingTable.setAttribute('customer-email', userObj.email);
									}
								}
							}

							// 6. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãµã‚ã£ã¨è¡¨ç¤ºn 
							document.getElementById('pricing-modal').style.display = 'flex';
						};

						// é€ä¿¡ãƒœã‚¿ãƒ³ã®åˆ¶é™
						// 7. ãƒ¢ãƒ‡ãƒ«ã®å¤§ãã•ã‚’å–å¾—ã—ã¦æ¶ˆè²»é‡ã‚’è¨ˆç®—
						const modelName = getCurrentModel(); // ç”»é¢ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«åã‚’å–å¾—ã™ã‚‹é–¢æ•°
						
						// æ–‡å­—åˆ—ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿åˆ¤å®šï¼ˆincludesã‚„indexOfã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
						if (modelName && modelName.length > 0) {
							const cost = calculateCost(modelName); // æ¶ˆè²»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®è¨­å®š

							// 8. é€ä¿¡ãƒœã‚¿ãƒ³ã®ç‰©ç†çš„åˆ¶é™(ãƒ¢ãƒ‡ãƒ«åãŒå­˜åœ¨ã™ã‚‹ã¨ãã®ã¿ã€includesã®ã‚¨ãƒ©ãƒ¼å›é¿)
							const sendBtn = document.getElementById('send-message-button');
							if (sendBtn) {
								// ğŸ’¡ ãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ãŸæ¶ˆè²»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’åˆ¤å®š
								if (credits < cost) {
									// ğŸ”´ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆä¸è¶³æ™‚ã®è¨­å®š
									// 1. ãƒœã‚¿ãƒ³ã‚’ç‰©ç†çš„ã«ç„¡åŠ¹åŒ–ï¼ˆEdgeã®æ¨™æº–æ©Ÿèƒ½ï¼‰
									sendBtn.disabled = true;
									sendBtn.style.pointerEvents = "none"; // ãƒã‚¦ã‚¹åå¿œã‚’æ¶ˆã™
									sendBtn.style.opacity = "0.4";

									// 2. æ—¢å­˜ã®ã€Œé€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’ã™ã¹ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ä¸Šæ›¸ãã™ã‚‹ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§é˜»æ­¢ï¼‰
									sendBtn.addEventListener('click', function(e) {
										e.stopImmediatePropagation(); // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆOpen WebUIå´ï¼‰ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¸¡ã•ãªã„
										e.preventDefault();           // æ¨™æº–ã®é€ä¿¡å‹•ä½œã‚’æ­¢ã‚ã‚‹
										console.log("[hiroto99.com] Related Question Blocked: Insufficient Credits");
										
										// ğŸ’¡ ã“ã“ã§æ–™é‡‘ãƒ—ãƒ©ãƒ³ç”»é¢ã‚’å‡ºã™
										forceOpenPricing(cost);
									}, true); // ç¬¬3å¼•æ•°ã‚’ true ã«ã—ã¦å„ªå…ˆåº¦ã‚’æœ€ä¸Šä½ã«ã™ã‚‹

									sendBtn.setAttribute('title', `æ®‹é«˜ä¸è¶³ï¼ˆå¿…è¦: ${cost}cï¼‰ã€‚ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒãƒ£ãƒ¼ã‚¸ã€‚`);
								} else {
									// ğŸ”µ é€šå¸¸æ™‚ã®è¨­å®š
									sendBtn.disabled = false;
									sendBtn.style.pointerEvents = "auto";
									sendBtn.style.opacity = "1";
									
									// ğŸ’¡ ãƒ›ãƒãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€šå¸¸ã®é€ä¿¡ãƒ©ãƒ™ãƒ«ã«æˆ»ã™
									sendBtn.setAttribute('title', `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ (${cost}c æ¶ˆè²»)`);
									sendBtn.setAttribute('aria-label', 'Send Message');
								}
							}

							/* --- ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼é€ä¿¡ã®å¼·åˆ¶èª²é‡‘ï¼ˆShift+Enterã¯é™¤å¤–ï¼‰ --- */
							window.addEventListener('keydown', function(e) {
								// 1. Enterä»¥å¤–ã®ã‚­ãƒ¼ã€ã¾ãŸã¯ã€Œæ”¹è¡Œæ“ä½œã€ã®å ´åˆã¯å³çµ‚äº†ï¼ˆã‚¹ãƒ«ãƒ¼ï¼‰
								// ğŸ’¡Shift + Enter ã‚’æ”¹è¡Œã¨ã—ã¦æ‰±ã†
								if (e.key !== 'Enter' || e.metaKey || e.shiftKey) {
									return; 
								}

								// 2. ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ç™ºå‹•ä¸­ãªã‚‰ã€é€ä¿¡å‹•ä½œãã®ã‚‚ã®ã‚’å®Œå…¨ã«æ®ºã™
								if (window.hiroto99_is_locked) {
									e.stopImmediatePropagation();
									e.preventDefault();
									return false;
								}

								// 3. å…¥åŠ›æ¬„ï¼ˆtextareaï¼‰ã§ã®ç¢ºå®šEnteræ“ä½œã‹ç¢ºèª
								const isChatInput = e.target.tagName === 'TEXTAREA' || e.target.id === 'chat-input';

								if (isChatInput) {
									// 4. æ®‹é«˜ä¸è¶³ãƒã‚§ãƒƒã‚¯
									if (credits < cost) {
										e.stopImmediatePropagation();
										e.preventDefault();
										console.log("[hiroto99.com] Enter blocked: Need " + cost + "c");
										forceOpenPricing(cost); 
										return false;
									}

									// 5. ğŸ’¡ ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ç™ºå‹•ï¼ˆ0.8ç§’é–“ãƒ­ãƒƒã‚¯ï¼‰
									window.hiroto99_is_locked = true;
									
									// n8nã¸æ¸›ç®—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ
									console.log("[hiroto99.com] Valid Enter Send. Consuming " + cost + "c...");
									consumeCreditsViaN8n(cost);

									// 6. ãƒ­ãƒƒã‚¯è§£é™¤
									setTimeout(() => {
										window.hiroto99_is_locked = false;
									}, 800);
								}
							}, true); // Capture phase (æœ€å„ªå…ˆ)
						}
						saveCredits(credits); // ğŸ’¡ æœ€æ–°ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ã‚»ãƒ¼ãƒ–
					} catch (e) { console.error("Update Error:", e); }
				}

				function getCurrentModel() {
					let modelName = "";
					try {
						// ğŸ’¡ å…±æœ‰ã„ãŸã ã„ãŸHTMLæ§‹æˆã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§ç‹™ã†
						const modelDiv = document.querySelector('div.flex.w-full.text-left.truncate.text-lg.justify-between');
						
						// å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¨ãƒ†ã‚­ã‚¹ãƒˆã®æœ‰ç„¡ã‚’ç¢ºèª
						if (modelDiv && modelDiv.innerText) {
							modelName = String(modelDiv.innerText).trim().toLowerCase();
						}
					} catch (e) {
						console.warn("Model div not found yet...");
					}
					
					// è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™ï¼ˆtoLowerCaseã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
					return modelName || "";
				}

				function setupChatMonitor() {
					const sendBtn = document.getElementById('send-message-button');
					if (sendBtn && !sendBtn.dataset.hooked) {
						sendBtn.dataset.hooked = "true";
						
						// å…ƒã®ã‚¯ãƒªãƒƒã‚¯å‹•ä½œã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã«ç›£è¦–
						sendBtn.addEventListener('click', async () => {
							consumeCreditsViaN8n();
						});
					}
				}

				/* --- é–¢é€£ä¼šè©±ï¼ˆRelated Questionsï¼‰ã®é‰„å£ã‚¬ãƒ¼ãƒ‰ --- */
				function setupRelatedQuestionMonitor() {
					/* --- 100% é‡è¤‡èª²é‡‘ã‚’é˜²ãã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ»ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ --- */
					window.addEventListener('click', function(e) {
						// 1. ãƒ­ãƒƒã‚¯ä¸­ãªã‚‰ã€ã“ã®ã‚¯ãƒªãƒƒã‚¯ã¯ã€Œç„¡ã‹ã£ãŸã“ã¨ã€ã«ã™ã‚‹
						if (window.hiroto99_is_locked) {
							console.log("[hiroto99.com] Duplicate click blocked by Stopper.");
							return false;
						}

						const target = e.target;
						// èª²é‡‘å¯¾è±¡ã®åˆ¤å®šï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ç­‰ã¯é™¤å¤–ï¼‰
						const isRelated = target.closest('.cursor-pointer.flex.items-center.gap-2.text-gray-500');
						const isDelete = target.closest('button[aria-label*="Delete"]') || target.closest('.delete-btn');

						if (isRelated && !isDelete) {
							const cost = calculateCost(getCurrentModel());
							const credits = loadCredits();

							// æ®‹é«˜ä¸è¶³ãƒã‚§ãƒƒã‚¯
							if (credits < cost) {
								e.stopImmediatePropagation();
								e.preventDefault();
								forceOpenPricing(cost);
								return false;
							}

							// ğŸ’¡ ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ç™ºå‹•ï¼
							window.hiroto99_is_locked = true;
							console.log("[hiroto99.com] Processing... Stopper LOCKED.");

							// n8nã¸æ¸›ç®—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
							consumeCreditsViaN8n(cost);

							// ğŸ’¡ 0.8ç§’å¾Œã«ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆé€£æ‰“ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã®é‡è¤‡ã‚’å®Œå…¨ã«å¸åï¼‰
							setTimeout(() => {
								window.hiroto99_is_locked = false;
								console.log("[hiroto99.com] Stopper UNLOCKED.");
							}, 800);
						}
					}, true); // Capture phase (æœ€å„ªå…ˆ)
				}

				function setupSuggestionMonitor() {
					// ğŸ’¡ ææ¡ˆãƒœã‚¿ãƒ³ (waterfall) ã®ã‚¯ãƒªãƒƒã‚¯ç›£è¦–ã¨å¼·åˆ¶èª²é‡‘
					const waterfallBtns = document.querySelectorAll('button[role="listitem"].waterfall');
					waterfallBtns.forEach(btn => {
						// äºŒé‡ç™»éŒ²é˜²æ­¢
						if (!btn.dataset.hooked) {
							btn.dataset.hooked = "true";

							// ğŸ’¡ Captureãƒ•ã‚§ãƒ¼ã‚º(true)ã§å‰²ã‚Šè¾¼ã¿ã€Open WebUIã®ãƒãƒ£ãƒƒãƒˆé–‹å§‹å‡¦ç†ã‚’é˜»æ­¢ã™ã‚‹
							btn.addEventListener('click', function(e) {
								const credits = loadCredits();
								const cost = calculateCost(getCurrentModel());

								if (credits < cost) {
									// ğŸ”´ æ®‹é«˜ä¸è¶³ï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Œå…¨ã«åœæ­¢ã—ã€æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’å©ãã¤ã‘ã‚‹
									e.stopImmediatePropagation();
									e.preventDefault();
											
									console.log("[hiroto99.com] Waterfall Suggestion Blocked: Insufficient Credits");
									forceOpenPricing(cost); // ğŸ’¡ ä½œæˆæ¸ˆã¿ã®å¼·åˆ¶è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰
									return false;
								}

								// ğŸ”µ æ®‹é«˜ã‚ã‚Šï¼šn8nã¸æ¶ˆè²»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™
								console.log("[hiroto99.com] Waterfall Suggestion Accepted. Consuming " + cost + "c");
								consumeCreditsViaN8n(cost);
							}, true); 
						}
					});
				}

				async function consumeCreditsViaN8n() {
					console.log("Chat Message Detected. Calling n8n...");
					
					const token = localStorage.getItem('token');
					if (!token) return;
					const userId = JSON.parse(atob(token.split('.')[1])).id;

					// ğŸ’¡ ãƒ¢ãƒ‡ãƒ«åã‚’ç”»é¢ã‹ã‚‰å–å¾—ï¼ˆOpen WebUIã®ãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã«ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«åï¼‰
					const modelName = getCurrentModel();
					
					try {
						const response = await fetch(USE_API_URL, {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ user_id: userId, model_name: modelName })
						});
						
						const result = await response.json();
						
						// ç”»é¢ä¸Šã®æ•°å€¤ã‚’å³åº§ã«æ›´æ–°
						const displayEl = document.getElementById('final-credits-display');
						if (displayEl && result.credits !== undefined) {
							displayEl.innerText = result.credits + " c";
						}
					} catch (e) {
						console.error("N8N Consumption Error:", e);
					}
				}

				//** æœ€æ–°ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ã‚»ãƒ¼ãƒ–ã™ã‚‹ **//
				function saveCredits(newCredits) {
					creditsSave = newCredits;
				};

				//** æœ€æ–°ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ **//
				function loadCredits() {
					return creditsSave;
				};

				//** ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° **//
				function calculateCost(modelName) {
					let cost = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¶ˆè²»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
					if (modelName.includes('14b')) {
						cost = 3;
					} else if (modelName.includes('7b') || modelName.includes('8b') || modelName.includes('latest')) {
						cost = 2;
					}
					return cost;
				}

				function forceOpenPricing(required) {
					console.log(`[hiroto99.com] Access Denied: Need ${required}c. Launching Pricing Table.`);
							
					// 1. æ–™é‡‘è¡¨ã«æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ³¨å…¥ï¼ˆä»¥å‰ã®æˆåŠŸãƒ­ã‚¸ãƒƒã‚¯ï¼‰
					const token = localStorage.getItem('token');
					if (token) {
						const payload = JSON.parse(atob(token.split('.')[1]));
						const table = document.getElementById('hiroto99-pricing-table');
						if (table) {
							table.setAttribute('client-reference-id', payload.id);
						}
					}

					// 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã€Œæœ€å‰é¢ã€ã«ã€Œå¼·åˆ¶è¡¨ç¤ºã€
					const modal = document.getElementById('pricing-modal');
					if (modal) {
						modal.style.display = 'flex';
						modal.style.opacity = '1';
						modal.style.visibility = 'visible';
						modal.style.zIndex = '2147483647'; // ç‰©ç†çš„é™ç•Œå€¤
					}

					// 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆãŠå¥½ã¿ã§ï¼‰
					// alert(`ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: ${required}cï¼‰ã€‚ãƒãƒ£ãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚`);
				};

				// é€ä¿¡ãƒœã‚¿ãƒ³ã®ç›£è¦–
				setInterval(() => {
					refresh();                     // æ®‹é«˜è¡¨ç¤ºæ›´æ–° & ãƒœã‚¿ãƒ³ã®ç‰©ç†ç„¡åŠ¹åŒ–
					setupChatMonitor();            // ãƒ¡ã‚¤ãƒ³é€ä¿¡ãƒœã‚¿ãƒ³(id=send-message-button)ç›£è¦–
					setupRelatedQuestionMonitor(); // é–¢é€£è³ªå•(cursor-pointer)ç›£è¦–
					setupSuggestionMonitor();      // ğŸ’¡ ææ¡ˆãƒœã‚¿ãƒ³(waterfall)ç›£è¦–ã‚’è¿½åŠ 
				}, 1000);
				refresh();
			})();
		</script>
		<!-- hiroto99.com ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆçµ‚äº† -->
	</body>

	<style type="text/css" nonce="">
		html {
			overflow-y: hidden !important;
			overscroll-behavior-y: none;
		}

		#splash-screen {
			background: #fff;
		}

		html.dark #splash-screen {
			background: #000;
		}

		html.her #splash-screen {
			background: #983724;
		}

		#logo-her {
			display: none;
		}

		#progress-background {
			display: none;
		}

		#progress-bar {
			display: none;
		}

		html.her #logo {
			display: none;
		}

		html.her #logo-her {
			display: block;
			filter: invert(1);
		}

		html.her #progress-background {
			display: block;
		}

		html.her #progress-bar {
			display: block;
		}

		@media (max-width: 24rem) {
			html.her #progress-background {
				display: none;
			}

			html.her #progress-bar {
				display: none;
			}
		}

		@keyframes pulse {
			50% {
				opacity: 0.65;
			}
		}

		.animate-pulse-fast {
			animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
		}
	</style>
</html>
